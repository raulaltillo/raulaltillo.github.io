<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cal+Sans&display=swap" rel="stylesheet">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T470HXGPQZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T470HXGPQZ');
</script>
  <title>Horario | Raulaltillo </title>
  <meta name="description" content="Obtén información sobre el horario de tu clase" />
  <link rel="icon" href="../favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="../main.css">
  <meta name="color-scheme" content="light only">
  <style>
    .column {
    border-radius: 15px; /* Rounded corners */
    padding: 10px; /* Padding inside the columns */
    flex: 1; /* Ensure columns take equal width */
    margin:1px
}

.row {
    display: flex;
    justify-content: space-between; /* Distribute columns evenly */
}
  </style>
</head>
<body>
  <div class="topnav">
    <a href="./horario.html" class="active" >Horario</a>
    <a href="./menu.html">Menu</a>
    <!--<a href="./book_answers.html">Respuestas Libros</a>--->
    <a href="./selectividad.html">Selectividad</a>
        <a href="./herramientas.html">Herramientas</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdnBjqzIB08Ad6J5D6hyBe0z33kqKwkunFWNIXyWWmJCmnFjw/viewform?usp=sf_link" class="feedback-btn">Feedback</a>
    <!--<a href="pages/coding_answers.html">Coding/CS</a>-->
    <img class="title" id="weather-icon"  src="../images/weather-icon-illustration03-Graphics-10205167-1.png" alt="Clima actual" width="50px">
    <p class="anunciosdisplay"></p>
  </div>
  
  <div id="weatherIframeContainer" class="weather-iframe-container">
    <iframe name="iframe_aemet_id33044" src="https://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/jerez-de-la-frontera-id11020?w=g4p011100000ohmffffffx000000t999999r1s8n2" scrolling="no"></iframe>
  </div>
  <div id="content">
      <br>
  <br>
  <br>
  <div style="border: solid 15px #0b0b0b; border-radius: 10px; padding:20; margin:20px">
  <div id="scheduleContainer" style="display: none;">
    <div id="schedule"></div>
</div>
  <div style="text-align: center; margin: 20px;">
    <label for="classSelect" style="font-size: 2em;color: #ffffff;font-family: Cal Sans;">Clase:</label>
    <select id="classSelect" onchange="selectClass()" style="font-size: 2em;font-family: Cal Sans;cursor: pointer;">
      <option value="">--Seleccionar Clase--</option>
    </select>
    
  <br>
  <br>
  <label for="colorSelect" style="font-size:2em;color: #ffffff;font-family: Cal Sans;" >Color:</label>
  <input type="color" id="colorSelect" oninput="changeColor()" style="font-size:2em;cursor:pointer">
</div>
</div>
<script defer type="text/javascript">
const SHEET_URL = "https://sheetjson.com/spreadsheets/d/1OPkrvh0ccT4O2pbTp5NmIfcqXmHgOQyZWwhEAtrUfCY/edit?gid=1188799114"; 
// ⬆️ Replace with your actual SheetJSON URL

function LightenDarkenColor(col, amt) {
    let usePound = false;

    if (col[0] === "#") {
        col = col.slice(1);
        usePound = true;
    }

    let num = parseInt(col, 16);

    let r = (num >> 16) + amt;
    if (r > 255) r = 255;
    else if (r < 0) r = 0;

    let g = ((num >> 8) & 0x00FF) + amt;
    if (g > 255) g = 255;
    else if (g < 0) g = 0;

    let b = (num & 0x0000FF) + amt;
    if (b > 255) b = 255;
    else if (b < 0) b = 0;

    let newColor = (r << 16) | (g << 8) | b;
    return (usePound ? "#" : "") + newColor.toString(16).padStart(6, "0");
}

const days = ["Lunes", "Martes", "Miercoles", "Jueves", "Viernes"];
const PERIOD_KEYS = ["p1","p2","p3","p4","p5","p6","p7","p8","p9"];

const defaultColor = "#2d9e00";
let timetable = {};              // { [className]: { [dayName]: [subjects...] } }
let isTimetableLoaded = false;

// Generate shades for the background colors
const colors = (baseColor) => [
    baseColor,
    LightenDarkenColor(baseColor, 15),
    LightenDarkenColor(baseColor, 30),
    LightenDarkenColor(baseColor, 45),
    LightenDarkenColor(baseColor, 60),
];

function extractSubjects(row) {
    return PERIOD_KEYS.map((key) => row[key] || "");
}

// Show error message in the UI if fetch fails
function showTimetableError() {
    const scheduleDiv = document.getElementById("schedule");
    const container = document.getElementById("scheduleContainer");
    const select = document.getElementById("classSelect");

    if (scheduleDiv) {
        scheduleDiv.innerHTML = `
            <h1 style="color:#ffffff;font-family:Cal Sans;text-align:center;margin:20px;">
                No se puede cargar los horarios, contáctame lo antes posible.
            </h1>
        `;
    }
    if (container) {
        container.style.display = "block";
    }
    if (select) {
        select.disabled = true;
    }
}

// Fill the <select> with class names detected in the sheet
function populateClassSelect() {
    const select = document.getElementById("classSelect");
    if (!select) return;

    // Keep only the first option (placeholder)
    while (select.options.length > 1) {
        select.remove(1);
    }

    Object.keys(timetable).forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
    });
}

async function loadTimetable() {
    try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) {
            console.error("Error fetching timetable", res.status, res.statusText);
            showTimetableError();
            return;
        }

        const rows = await res.json();

        if (!Array.isArray(rows) || rows.length === 0) {
            console.error("No timetable rows in sheet");
            showTimetableError();
            return;
        }

        timetable = {};

        rows.forEach((row) => {
            const className = row.class_name;
            const dayName = row.day;
            if (!className || !dayName) return;

            if (!timetable[className]) timetable[className] = {};
            timetable[className][dayName] = extractSubjects(row);
        });

        isTimetableLoaded = true;

        populateClassSelect();

        const savedClass = localStorage.getItem("selectedClass");
        const savedColor = localStorage.getItem("selectedColor") || defaultColor;

        if (savedColor) {
            document.getElementById("colorSelect").value = savedColor;
        }

        if (savedClass && timetable[savedClass]) {
            document.getElementById("classSelect").value = savedClass;
            displayClassSchedule(savedClass);
        }

        updateScheduleColors(savedColor);

        document.getElementById("classSelect").disabled = false;
        document.getElementById("scheduleContainer").style.display = "block";
    } catch (err) {
        console.error("Error loading timetable", err);
        showTimetableError();
    }
}

function changeColor() {
    const newColor = document.getElementById("colorSelect").value;
    localStorage.setItem("selectedColor", newColor);
    updateScheduleColors(newColor);
}

function getClassScheduleForClass(className) {
    const perDay = timetable[className] || {};
    return days.map((day) => {
        const subjects = perDay[day];
        if (Array.isArray(subjects)) return subjects;
        return ["","","","","","","","",""];
    });
}

function updateScheduleColors(baseColor) {
    const updatedColors = colors(baseColor);
    const selectedClass = document.getElementById("classSelect").value;

    if (selectedClass && timetable[selectedClass]) {
        const classSchedule = getClassScheduleForClass(selectedClass);
        document.getElementById("schedule").innerHTML =
            generateScheduleHTML(classSchedule, updatedColors);
    }
}

function generateDayColumn(day, subjects, color) {
    return `
        <div class="column" style="background-color:${color};">
            <h3 style="font-family:Hacked">${day}</h3>
            <pre>${subjects.join("\n")}</pre>
        </div>`;
}

function generateScheduleHTML(
    classSchedule,
    colorPalette = colors(document.getElementById("colorSelect").value)
) {
    return `<div class="row">
        ${classSchedule
            .map((subjects, index) =>
                generateDayColumn(days[index], subjects, colorPalette[index])
            )
            .join("")}
    </div>`;
}

function selectClass() {
    if (!isTimetableLoaded) return;
    const selectedClass = document.getElementById("classSelect").value;
    if (selectedClass) {
        localStorage.setItem("selectedClass", selectedClass);
        displayClassSchedule(selectedClass);
    }
}

function displayClassSchedule(className) {
    const classSchedule = getClassScheduleForClass(className);
    document.getElementById("schedule").innerHTML =
        generateScheduleHTML(classSchedule);
    document.getElementById("scheduleContainer").style.display = "block";
}
window.onload = function() {
    const savedColor = localStorage.getItem("selectedColor") || defaultColor;
    document.getElementById("colorSelect").value = savedColor;

    // Disable class select until data is loaded
    document.getElementById("classSelect").disabled = true;
    document.getElementById("scheduleContainer").style.display = "none";

    loadTimetable();
};
</script>

</div>
  <script async src="../scripts/fade.js"></script>
</body>
