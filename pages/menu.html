<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T470HXGPQZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T470HXGPQZ');
</script>
    <title>Menu Altillo</title>
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../main.css">
    <title>Horario de 1 Bach | Raulaltillo </title>
    <meta name="description" content="Mira aqui el menu del dia" />
</head>
<body>
  <div class="topnav">
    <img class="title" id="weather-icon"  src="../images/weather-icon-illustration03-Graphics-10205167-1.png" alt="Clima actual" width="50px">
    <a href="./horario.html">Horario</a>
    <a class="active" href="#">Menu</a>
    <!--<a href="./book_answers.html">Respuestas Libros</a>--->
    <a href="./selectividad.html">Selectividad</a>
        <a href="./herramientas.html">Herramientas</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdnBjqzIB08Ad6J5D6hyBe0z33kqKwkunFWNIXyWWmJCmnFjw/viewform?usp=sf_link" class="feedback-btn">Feedback</a>
    <!--<a href="pages/coding_answers.html">Coding/CS</a>-->
  </div>
  <div id="weatherIframeContainer" class="weather-iframe-container">
  <iframe name="iframe_aemet_id33044" src="https://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/jerez-de-la-frontera-id11020?w=g4p011100000ohmffffffx000000t999999r1s8n2" scrolling="no"></iframe>
</div>
  <div id="content">
  <br>
  <br>
  <br>
  <br>
<center>
  <pre style="font-size: 200%;color: #ffffff;font-family: Verdana;font-weight:bold;", id="todaydata">Algo ha fallado</pre>
  <img src="../images/menu.png" width="90%" style="border: solid 15px #aeaeae; border-radius: 10px;">
</center>
<script>
  const SHEET_JSON_URL = "https://sheetjson.com/spreadsheets/d/1OPkrvh0ccT4O2pbTp5NmIfcqXmHgOQyZWwhEAtrUfCY?gid=945627682";

  function getFormattedDate() {
    const daysOfWeek = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
    const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sept", "Oct", "Nov", "Dic"];
    
    const today = new Date();
    const dayOfWeek = daysOfWeek[today.getDay()];
    const day = today.getDate();
    const month = months[today.getMonth()];

    return `${dayOfWeek} ${day} ${month}`;
  }

  function parseSpanishDate(dateString) {
    const months = {
      'Ene': 0,
      'Feb': 1,
      'Mar': 2,
      'Abr': 3,
      'May': 4,
      'Jun': 5,
      'Jul': 6,
      'Ago': 7,
      'Sept': 8,
      'Oct': 9,
      'Nov': 10,
      'Dic': 11
    };

    const parts = dateString.split(" ");
    if (parts.length < 3) return null;

    const [weekday, day, month] = parts;
    const currentYear = new Date().getFullYear();
    return new Date(currentYear, months[month], parseInt(day, 10), 23, 59);
  }

  function buildMenuFromSheet(rows) {
    const menu = {};
    rows.forEach(row => {
      // SheetJSON devuelve las propiedades con el nombre de los encabezados
      const key = row.date_key;
      if (!key) return;
      const first = row.first || "";
      const second = row.second || "";
      const dessert = row.dessert || "";
      menu[key] = [first, second, dessert];
    });
    return menu;
  }

  function getLastMenuDateKey(menu) {
    const keys = Object.keys(menu);
    if (!keys.length) return null;
    return keys.sort((a, b) => {
      const da = parseSpanishDate(a);
      const db = parseSpanishDate(b);
      if (!da || !db) return 0;
      return da - db;
    })[keys.length - 1];
  }

  function getTodaysMenu(menu) {
    const today = getFormattedDate();
    const todayDate = new Date();
    const isWeekend = (todayDate.getDay() === 0 || todayDate.getDay() === 6);

    const lastKey = getLastMenuDateKey(menu);
    if (lastKey) {
      const lastDate = parseSpanishDate(lastKey);
      if (lastDate && new Date() > lastDate) {
        return `Menú de hoy (${today}):\n\nDatos no disponibles (desactualizado)`;
      }
    }

    if (isWeekend) {
      return `Menú de hoy (${today}):\n\nNo hay menú disponible hoy`;
    } else if (menu[today.toLowerCase()]) {
      return `Menú de hoy (${today}):\n\n${menu[today.toLowerCase()].join('\n')}`;
    } else {
      return `Menú de hoy (${today}):\n\nNo hay datos disponibles`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const todayElem = document.getElementById("todaydata");
    todayElem.textContent = "Cargando menú...";

    fetch(SHEET_JSON_URL)
      .then(response => response.json())
      .then(data => {
        const menu = buildMenuFromSheet(data);
        todayElem.textContent = getTodaysMenu(menu);
      })
      .catch(err => {
        console.error(err);
        todayElem.textContent = "Menú de hoy:\n\nNo se ha podido cargar el menú";
      });
  });
</script>
</div>
<script async src="../scripts/fade.js"></script>


</body>
