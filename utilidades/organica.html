<!DOCTYPE html>
<html lang="es">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T470HXGPQZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T470HXGPQZ');
</script>
<meta charset="utf-8" />
<title>Orgánica | Raulaltillo</title>
<link rel="icon" href="../favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../main.css">
<style>
  :root{ --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#22c55e; --err:#ef4444; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ color:var(--ink); background:#1a1a1a; font-family: Arial, Helvetica, sans-serif; }
  .app{ max-width:1100px; background:#2d2d2d; backdrop-filter: blur(6px);
        border:solid 15px #0b0b0b; border-radius:10px; padding:24px; margin: 20px auto; }
  h1{ margin:0 0 8px; font-weight:400; letter-spacing:.2px; font-family: Hacked; }
  .card{ background:#2d2d2d; border:solid 15px #0b0b0b; border-radius:10px; padding:16px }
  .label{ color:#e0e0e0; font-size:12px; text-transform:uppercase; letter-spacing:.08em; font-family: Hacked }
  .big{ font-size:24px; font-weight:700; margin:4px 0 0 }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .btn{ appearance:none; border:none; background:#2D7A5E; color:#e0e0e0; font-weight:800;
        padding:12px 16px; border-radius:12px; cursor:pointer; transition:background-color 0.3s }
  .btn[disabled]{ opacity:.6; cursor:not-allowed }
  .btn:hover{ background-color:#1e5542 }
  .btn.secondary{ background:#3d3d3d; color:#e0e0e0 }
  .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#1a1a1a; border:1px solid #1f2937; color:#e0e0e0 }
  .status{ margin-top:8px; font-weight:700 }
  .ok{ color:#22c55e } .bad{ color:#ef4444 } .hint{ color:#e0e0e0 }

  /* LAYOUT: izquierda (fórmula + datos) apilados, derecha imagen */
  .grid2{ display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
  .leftStack{ display:grid; grid-template-rows:auto auto; gap:16px; }

  .molimg-wrap{ display:flex; justify-content:center; align-items:center; height:100%; }
  #molImg{ width:100%; max-width:300px; height:auto; aspect-ratio:1/1; object-fit:contain;
           background:#1a1a1a; border:1px solid #000; border-radius:8px }

  .actions{ margin-top:16px; display:flex; gap:12px; flex-wrap:wrap; }

  @media (max-width: 900px){
    .grid2{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="topnav">
    <img class="title" id="weather-icon" src="../images/weather-icon-illustration03-Graphics-10205167-1.png" alt="Clima actual" width="50px">
    <a href="../pages/horario.html">Horario</a>
    <a href="../pages/menu.html">Menu</a>
    <a href="../pages/selectividad.html">Selectividad</a>
    <a href="../pages/herramientas.html" class="active">Herramientas</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdnBjqzIB08Ad6J5D6hyBe0z33kqKwkunFWNIXyWWmJCmnFjw/viewform?usp=sf_link" class="feedback-btn">Feedback</a>
  </div>

  <div id="weatherIframeContainer" class="weather-iframe-container">
    <iframe name="iframe_aemet_id33044" src="https://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/jerez-de-la-frontera-id11020?w=g4p011100000ohmffffffx000000t999999r1s8n2" scrolling="no"></iframe>
  </div>

  <div id="content">
    <br><br><br>
    <div class="app">
      <h1>Formulacion organica</h1>

      <div class="grid2">
        <div class="leftStack">
          <div class="card">
            <div class="label">Formula semidesarrollada</div>
            <div id="semi" class="big mono">—</div>
          </div>

          <div class="card">
            <div class="label">Datos</div>
            <div class="row" style="gap:8px; margin-top:6px">
              <span class="badge" id="badgeFam">Familia: <span id="familia">—</span></span>
              <span class="badge" id="badgeFor">Fórmula: <span id="formula">—</span></span>
            </div>
            <div id="status" class="status hint" style="margin-top:10px">—</div>
          </div>
        </div>

        <div class="card molimg-wrap">
          <img id="molImg" alt="Estructura">
        </div>
      </div>

      <div class="actions">
        <button id="newBtn" class="btn secondary">Nueva cadena</button>
        <button id="imgBtn" class="btn">Generar imagen</button>
        <label class="row hint" style="margin-left:auto">
          <input id="showFam" type="checkbox" style="accent-color:#22d3ee; margin-right:6px;"> Mostrar familia
        </label>
        <label class="row hint">
          <input id="showFor" type="checkbox" style="accent-color:#22d3ee; margin-right:6px;"> Mostrar fórmula
        </label>
      </div>
    </div>

<script>
/* ========== Utilidades y datos ========== */
// --- Placeholders de imagen ---
function svgDataUri(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }

const IMG_BLANK = svgDataUri(`
<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
  <rect width="100%" height="100%" fill="#0b0b0b"/>
  <text x="50%" y="50%" fill="#333" font-family="Arial, Helvetica, sans-serif" font-size="20" text-anchor="middle" dominant-baseline="middle">
    (sin imagen)
  </text>
</svg>`);

const IMG_LOADING = svgDataUri(`
<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
  <rect width="100%" height="100%" fill="#0b0b0b"/>
  <g transform="translate(256,256)">
    <circle r="80" fill="none" stroke="#1f2937" stroke-width="12"/>
    <path d="M0,-80 A80,80 0 0,1 0,80" fill="none" stroke="#22d3ee" stroke-linecap="round" stroke-width="12">
      <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="1s" repeatCount="indefinite"/>
    </path>
  </g>
  <text x="50%" y="85%" fill="#555" font-family="Arial, Helvetica, sans-serif" font-size="16" text-anchor="middle">(generando imagen)</text>
</svg>`);

const $ = (sel)=>document.querySelector(sel);

// --- Historial para no repetir compuestos (persistente en localStorage) ---
const HISTORY_KEY = 'organica_seen_cids_v1';
const SEEN_LIMIT = 100; // límite de CIDs guardados
function loadSeenCIDs(){
  try { return new Set(JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]')); }
  catch { return new Set(); }
}
function saveSeenCIDs(set){
  const arr = Array.from(set);
  const trimmed = arr.length > SEEN_LIMIT ? arr.slice(arr.length - SEEN_LIMIT) : arr;
  localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed));
}
let SEEN_CIDS = loadSeenCIDs();

const SUBS_TYPES = {
  metil:{name:"metil"}, etil:{name:"etil"},
  fluoro:{name:"fluoro"}, cloro:{name:"cloro"}, bromo:{name:"bromo"}, iodo:{name:"iodo"},
  nitro:{name:"nitro"}, hidroxi:{name:"hidroxi"}, amino:{name:"amino"},
  metoxi:{name:"metoxi"}, etoxi:{name:"etoxi"},
};
const rint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = (arr)=>arr[Math.floor(Math.random()*arr.length)];

/* ========== Generación (más estricta) ========== */
const FAMILIAS = ["acido","nitrilo","aldehido","cetona","alcohol","amina","alqueno","alquino","alcano","halogenuro","nitro"];

function genCadena(nMin=2,nMax=9){ return rint(nMin,nMax); }

function genUnsat(n, minPos = 1){
  if(n < 2) return { db: [], tb: [] };
  const low = Math.max(1, minPos), high = n-1;
  if(low>high) return { db: [], tb: [] };
  const t = choice(["none","ene","ino","ene","none"]);
  if(t==="none") return {db:[],tb:[]};
  const pos = rint(low,high);
  return t==="ene" ? {db:[pos], tb:[]} : {db:[], tb:[pos]};
}

function genSustituyentes(n, fg){
  const count = rint(0,2);
  const pool = Object.keys(SUBS_TYPES).filter(t=>{
    if(fg==="alcohol" && t==="hidroxi") return false; // evita duplicar FG
    if(fg==="amina" && t==="amino") return false;
    return true;
  });
  const used = new Map();
  const out=[];
  for(let i=0;i<count;i++){
    const type = choice(pool);
    let p = rint(1,n);
    if((fg==="acido"||fg==="nitrilo"||fg==="aldehido") && p===1) p = Math.min(2,n); // evita C1
    const k = `${p}`;
    used.set(k, (used.get(k)||0)+1);
    if(used.get(k) > 2){ i--; continue; }  // evita >2 ramas en el mismo C
    out.push({pos:p,type});
  }
  return out;
}

function genMolecula(){
  const fam = choice(FAMILIAS);
  let n = genCadena(2,9);
  let fg=null,posFG=[],db=[],tb=[],subs=[],formula="";

  if(fam==="acido"){
    n = genCadena(2,8);
    fg="acido"; posFG=[1]; db=[]; tb=[]; subs=[];
  }else if(fam==="nitrilo"){
    n = genCadena(2,9);
    fg="nitrilo"; posFG=[1]; db=[]; tb=[]; subs=genSustituyentes(n,fg);
  }else if(fam==="aldehido"){
    n = genCadena(2,9);
    fg="aldehido"; posFG=[1]; ({db,tb}=genUnsat(n,2)); subs=genSustituyentes(n,fg);
  }else if(fam==="cetona"){
    n = genCadena(3,9);
    fg="cetona"; posFG=[rint(2,n-1)]; db=[]; tb=[]; subs=genSustituyentes(n,fg);
  }else if(fam==="alcohol"){
    n = genCadena(1,9);
    fg="alcohol"; posFG=[ n===1?1:rint(1,n) ]; db=[]; tb=[]; subs=genSustituyentes(n,fg);
  }else if(fam==="amina"){
    n = genCadena(1,9);
    fg="amina"; posFG=[ n===1?1:rint(1,n) ]; db=[]; tb=[]; subs=genSustituyentes(n,fg);
  }else if(fam==="alqueno"){
    n = genCadena(2,9);
    ({db,tb}=genUnsat(n)); if(!db.length){ db=[rint(1,n-1)]; tb=[]; }
    subs=genSustituyentes(n,null);
  }else if(fam==="alquino"){
    n = genCadena(2,9);
    ({db,tb}=genUnsat(n)); if(!tb.length){ tb=[rint(1,n-1)]; db=[]; }
    subs=genSustituyentes(n,null);
  }else if(fam==="halogenuro"){
    n=genCadena(2,9); db=[]; tb=[];
    let k=rint(1,2); subs=[];
    while(k--) subs.push({pos:rint(1,n), type:choice(["fluoro","cloro","bromo","iodo"])});
    subs=subs.concat(genSustituyentes(n,null));
  }else if(fam==="nitro"){
    n=genCadena(2,9); ({db,tb}=genUnsat(n));
    let k=rint(1,2); subs=[];
    while(k--) subs.push({pos:rint(1,n), type:"nitro"});
    subs=subs.concat(genSustituyentes(n,null));
  }else{
    n=genCadena(1,10); db=[]; tb=[]; subs=genSustituyentes(n,null);
  }

  // Fórmula (Hill): C, H, luego alfabético
  function computeFormula(n, db, tb, fg, subs){
    let C=n, H=2*n+2; // base lineal
    H -= 2*db.length;
    H -= 4*tb.length;

    let O=0,N=0,F=0,Cl=0,Br=0,I=0;

    if(fg==="acido"){ O+=2; H-=2; }
    else if(fg==="nitrilo"){ N+=1; H-=3; }          // CH3 → C≡N (–3 H)
    else if(fg==="aldehido"){ O+=1; H-=2; }
    else if(fg==="cetona"){ O+=1; H-=2; }
    else if(fg==="alcohol"){ O+=1; }
    else if(fg==="amina"){ N+=1; H+=1; } // primaria

    subs.forEach(s=>{
      if(s.type==="metil"){ C+=1; H+=2; }
      else if(s.type==="etil"){ C+=2; H+=4; }
      else if(s.type==="metoxi"){ C+=1; H+=2; O+=1; }
      else if(s.type==="etoxi"){ C+=2; H+=4; O+=1; }
      else if(s.type==="hidroxi"){ O+=1; }
      else if(s.type==="amino"){ N+=1; H+=1; }
      else if(s.type==="fluoro"){ F+=1; H-=1; }
      else if(s.type==="cloro"){ Cl+=1; H-=1; }
      else if(s.type==="bromo"){ Br+=1; H-=1; }
      else if(s.type==="iodo"){ I+=1; H-=1; }
      else if(s.type==="nitro"){ N+=1; O+=2; H-=1; }
    });

    H=Math.max(H,0);
    const parts=[];
    if(C>0) parts.push(`C${C===1?"":C}`);
    if(H>0) parts.push(`H${H===1?"":H}`);
    const rest={Br,Cl,F,I,N,O};
    Object.keys(rest).sort().forEach(k=>{ if(rest[k]>0) parts.push(`${k}${rest[k]===1?"":rest[k]}`); });
    return parts.join("");
  }
  formula = computeFormula(n,db,tb,fg,subs);

  return {n,fg,posFG,db,tb,subs,formula};
}

/* ========== Orientación (LCML) ========== */
function mirrorPos(n,p){ return n+1-p; }
function mirrorBonds(n,arr){ return arr.map(p=>(n-p)).sort((a,b)=>a-b); }
function orientationKey(m,flip){
  const n=m.n;
  const anchorFG=(m.fg==="acido"||m.fg==="nitrilo"||m.fg==="aldehido");
  const fgLoc=anchorFG?[1]:(flip? m.posFG.map(p=>mirrorPos(n,p)).sort((a,b)=>a-b):[...m.posFG].sort((a,b)=>a-b));
  const d=flip? mirrorBonds(n,m.db):[...m.db].sort((a,b)=>a-b);
  const t=flip? mirrorBonds(n,m.tb):[...m.tb].sort((a,b)=>a-b);
  const s=(flip? m.subs.map(x=>mirrorPos(n,x.pos)):m.subs.map(x=>x.pos)).sort((a,b)=>a-b);
  return [fgLoc,d,t,s];
}
function lexLess(a,b){
  for(let i=0;i<Math.min(a.length,b.length);i++){
    const x=a[i],y=b[i];
    for(let j=0;j<Math.min(x.length,y.length);j++){ if(x[j]!==y[j]) return x[j]<y[j]; }
    if(x.length!==y.length) return x.length<y.length;
  }
  return false;
}
function orient(m){
  const n=m.n, anchor=(m.fg==="acido"||m.fg==="nitrilo"||m.fg==="aldehido");
  if(anchor){
    if(m.posFG[0]!==1){
      const subs=m.subs.map(s=>({pos:n+1-s.pos,type:s.type}));
      const posFG=m.posFG.map(p=>n+1-p);
      const db=m.db.map(p=>(n-p)).sort((a,b)=>a-b);
      const tb=m.tb.map(p=>(n-p)).sort((a,b)=>a-b);
      return {...m,subs,posFG,db,tb,flipped:true};
    }
    return {...m,flipped:false};
  }
  const useR=lexLess(orientationKey(m,true),orientationKey(m,false));
  if(!useR) return {...m,flipped:false};
  const subs=m.subs.map(s=>({pos:n+1-s.pos,type:s.type}));
  const posFG=m.posFG.map(p=>n+1-p);
  const db=m.db.map(p=>(n-p)).sort((a,b)=>a-b);
  const tb=m.tb.map(p=>(n-p)).sort((a,b)=>a-b);
  return {...m,subs,posFG,db,tb,flipped:true};
}

/* ========== Semidesarrollada coherente (= y ≡ y FG) ========== */
function semiBase(n){ if(n===1) return ["CH3"]; if(n===2) return ["CH3","CH3"]; return ["CH3",...Array(n-2).fill("CH2"),"CH3"]; }
function addBranch(frag, idx, tag){
  let f=frag[idx];
  if(f==="CH3"||f==="CH2"||f==="CHOH"||f==="CH2OH") f="CH";
  frag[idx]=f+tag;
}
function demoteOnce(tok){
  if(!tok) return tok;
  if(tok==="CH3") return "CH2";
  if(tok==="CH2") return "CH";
  if(tok==="CH")  return "C";
  if(tok==="CH2OH") return "CHOH";
  if(tok==="CHOH")  return "C(OH)";
  if(/^CH\(/.test(tok)) return tok.replace(/^CH\(/,"C(");
  return tok;
}
function demoteTwice(tok){ return demoteOnce(demoteOnce(tok)); }

function semiString(m){
  const {n, fg, posFG, db, tb, subs} = m;
  let fr = semiBase(n);

  // FG
  if(fg==="acido"){ fr[n-1]="C(=O)OH"; }
  if(fg==="nitrilo"){ fr[0]="C≡N"; }
  if(fg==="aldehido"){ fr[n-1]="CHO"; }
  if(fg==="cetona"){ const p=(posFG[0]||2)-1; fr[p]="C(=O)"; }
  if(fg==="alcohol"){ const p=(posFG[0]||1)-1; fr[p]=(p===0||p===n-1)?"CH2OH":"CHOH"; }
  if(fg==="amina"){ const p=(posFG[0]||1)-1; fr[p]=(fr[p]==="CH3"||fr[p]==="CH2")?"CH(NH2)":(fr[p]+"(NH2)"); }

  // Ramas
  subs.forEach(({pos,type})=>{
    const idx=pos-1;
    const tag= type==="metil"?"(CH3)"
      :type==="etil"?"(CH2CH3)"
      :type==="metoxi"?"(OCH3)"
      :type==="etoxi"?"(OCH2CH3)"
      :type==="hidroxi"?"(OH)"
      :type==="amino"?"(NH2)"
      :type==="fluoro"?"(F)"
      :type==="cloro"?"(Cl)"
      :type==="bromo"?"(Br)"
      :type==="iodo"?"(I)"
      :type==="nitro"?"(NO2)":"";
    if(tag) addBranch(fr,idx,tag);
  });

  // Insaturaciones (máx. 1)
  if(db.length && fr.length>1){
    const i=db[0];
    if(i>=1 && i<=n-1){ fr[i-1]=demoteOnce(fr[i-1]); fr[i]=demoteOnce(fr[i]); }
    const out=[];
    for(let k=0;k<n;k++){ out.push(fr[k]); if(k===i-1) out.push("="); else if(k<n-1) out.push("-"); }
    return out.join("");
  }
  if(tb.length && fr.length>1){
    const i=tb[0];
    if(i>=1 && i<=n-1){ fr[i-1]=demoteTwice(fr[i-1]); fr[i]=demoteTwice(fr[i]); }
    const out=[];
    for(let k=0;k<n;k++){ out.push(fr[k]); if(k===i-1) out.push("≡"); else if(k<n-1) out.push("-"); }
    return out.join("");
  }
  return fr.join("-");
}

/* ========== SMILES (lineal + ramas) ========== */
function smilesFromMolecule(m){
  const {n, fg, posFG, db, tb, subs} = m;
  const dbl = new Set(db.map(x=>x-0));
  const tpl = new Set(tb.map(x=>x-0));

  const bonds = [];
  for(let i=1;i<=n-1;i++){
    if(tpl.has(i)) bonds.push("#");
    else if(dbl.has(i)) bonds.push("=");
    else bonds.push("");
  }

  let base = Array(n).fill("C");

  if(fg==="acido"){ base[n-1] = "C(=O)O"; }
  else if(fg==="nitrilo"){ base[0] = "C#N"; }   // terminal en C1
  else if(fg==="aldehido"){ base[n-1] = "C=O"; }
  else if(fg==="cetona"){ const p=(posFG[0]||2)-1; base[p] = "C(=O)"; }
  else if(fg==="alcohol"){ const p=(posFG[0]||1)-1; base[p] = base[p] + "O"; }
  else if(fg==="amina"){ const p=(posFG[0]||1)-1; base[p] = base[p] + "N"; }

  // Construcción lineal
  let chainParts = [base[0]];
  for(let i=1;i<n;i++){
    chainParts.push((bonds[i-1]||"") + base[i]);
  }

  // Ramas
  function branchSMI(type){
    if(type==="metil") return "C";
    if(type==="etil") return "CC";
    if(type==="metoxi") return "OC";
    if(type==="etoxi") return "OCC";
    if(type==="hidroxi") return "O";
    if(type==="amino") return "N";
    if(type==="fluoro") return "F";
    if(type==="cloro") return "Cl";
    if(type==="bromo") return "Br";
    if(type==="iodo") return "I";
    if(type==="nitro") return "[N+](=O)[O-]";
    return "";
  }

  subs.forEach(({pos,type})=>{
    const i = pos-1;
    const sm = branchSMI(type);
    if(!sm) return;
    chainParts[i] += `(${sm})`;
  });

  return chainParts.join("");
}

/* ========== PubChem helpers ========== */
async function fetchJSON(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}
async function fetchCIDBySmiles(smiles){
  try{
    const j=await fetchJSON(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(smiles)}/cids/JSON`);
    return j?.IdentifierList?.CID?.[0] || null;
  }catch(_e){ return null; }
}

/* ========== Estado y render ========== */
let MOL=null;

function familiaTexto(m){
  if(m.fg) return m.fg;
  return m.db.length?"alqueno":(m.tb.length?"alquino":"alcano");
}
function updateBadges(){
  $("#badgeFam").style.display = $("#showFam").checked ? "inline-block":"none";
  $("#badgeFor").style.display = $("#showFor").checked ? "inline-block":"none";
}
function renderMolecula(){
  $("#semi").textContent = semiString(MOL);
  $("#familia").textContent = familiaTexto(MOL);
  $("#formula").textContent = MOL.formula;
  $("#molImg").src = IMG_BLANK; // en blanco hasta pulsar “Generar imagen”
  $("#status").className="status ok";
  $("#status").textContent="Molécula nueva y validada";
  updateBadges();
}

/* ========== Nueva cadena con VALIDACIÓN + NO REPETIR (SMILES → CID) ========== */
async function nuevaCadena(){
  $("#molImg").src = IMG_BLANK;
  $("#newBtn").disabled = true;
  $("#imgBtn").disabled = true;
  $("#status").className="status hint";
  $("#status").textContent="Generando y validando...";

  const MAX_TRIES = 60; // más intentos para evitar repetir
  for(let tries=0; tries<MAX_TRIES; tries++){
    const cand = orient(genMolecula());

    // Coherencias rápidas
    const needsO = ["acido","aldehido","cetona","alcohol"].includes(cand.fg) || cand.subs.some(s=>["metoxi","etoxi","hidroxi","nitro"].includes(s.type));
    if(needsO && !/O/.test(cand.formula)) continue;
    if(cand.fg==="aldehido" && cand.db.includes(cand.n-1)) continue;
    if(cand.fg==="acido" && cand.db.includes(cand.n-1)) continue;

    // SMILES → CID
    const smiles = smilesFromMolecule(cand);
    const cid = await fetchCIDBySmiles(smiles);
    if(!cid) continue;

    const cidStr = String(cid);
    if(SEEN_CIDS.has(cidStr)) continue; // ya visto → descarta

    // Acepta: guarda en historial y muestra
    SEEN_CIDS.add(cidStr);
    saveSeenCIDs(SEEN_CIDS);

    MOL = {...cand, smiles, cid};
    renderMolecula();
    $("#newBtn").disabled = false;
    $("#imgBtn").disabled = false; // activado SOLO tras validación
    return;
  }

  $("#status").className="status bad";
  $("#status").textContent = "No se encontraron moléculas nuevas sin repetir. Puedes limpiar el historial del navegador para empezar de cero (localStorage['"+HISTORY_KEY+"']).";
  $("#newBtn").disabled = false;
  $("#imgBtn").disabled = true;
}

/* ========== Imagen desde SMILES (bloqueo del botón tras usarlo) ========== */
async function generarImagen(){
  try{
    $("#imgBtn").disabled = true; // se desactiva al pulsar y queda así hasta “Nueva cadena”
    $("#molImg").src = IMG_LOADING;
    $("#status").className="status hint";
    $("#status").textContent="Generando imagen…";

    if(!MOL?.smiles){
      $("#status").className="status bad";
      $("#status").textContent="No hay SMILES válido.";
      $("#molImg").src = IMG_BLANK;
      return;
    }

    const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${encodeURIComponent(MOL.smiles)}/PNG?image_size=large`;

    const probe = new Image();
    probe.onload = ()=>{
      $("#molImg").src = url;
      $("#status").className="status ok";
      $("#status").textContent="Imagen generada";
      // botón permanece deshabilitado hasta “Nueva cadena”
    };
    probe.onerror = ()=>{
      $("#status").className="status bad";
      $("#status").textContent="No se pudo generar la imagen.";
      $("#molImg").src = IMG_BLANK;
      // Si quieres permitir reintento sin «Nueva cadena», descomenta:
      // $("#imgBtn").disabled = false;
    };
    probe.src = url;

  }catch(e){
    $("#status").className="status bad";
    $("#status").textContent="Error generando la imagen.";
    $("#molImg").src = IMG_BLANK;
  }
}

/* ========== Eventos y arranque ========== */
$("#newBtn").addEventListener("click", nuevaCadena);
$("#imgBtn").addEventListener("click", generarImagen);
$("#showFam").addEventListener("change", updateBadges);
$("#showFor").addEventListener("change", updateBadges);

nuevaCadena();
</script>
  </div>
<script async src="../scripts/fade.js"></script>
</body>
</html>
